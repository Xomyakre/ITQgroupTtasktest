# План выполнения тестового задания ITQ Group

## Обзор проекта
Backend-сервис для управления документами с переходами статусов, историей изменений и фоновой обработкой.

## Этапы выполнения

### Этап 1: Настройка проекта и инфраструктуры
- [ ] Создать Spring Boot проект (Maven/Gradle)
- [ ] Настроить Docker Compose для PostgreSQL
- [ ] Настроить Liquibase для миграций БД
- [ ] Настроить структуру проекта (пакеты: controller, service, repository, entity, dto, config)
- [ ] Добавить зависимости: Spring Boot Web, Spring Data JPA, PostgreSQL Driver, Liquibase

### Этап 2: Модель данных и миграции
- [ ] Создать сущность Document (id, номер, автор, название, статус, даты)
- [ ] Создать сущность DocumentHistory (кто, когда, действие, комментарий)
- [ ] Создать сущность ApprovalRegistry (реестр утверждений)
- [ ] Создать Enum для статусов: DRAFT, SUBMITTED, APPROVED
- [ ] Создать Enum для действий: SUBMIT, APPROVE
- [ ] Написать Liquibase миграции:
  - [ ] Таблица documents
  - [ ] Таблица document_history
  - [ ] Таблица approval_registry
  - [ ] Индексы для оптимизации запросов

### Этап 3: Репозитории и базовые сервисы
- [ ] Создать DocumentRepository (JPA)
- [ ] Создать DocumentHistoryRepository
- [ ] Создать ApprovalRegistryRepository
- [ ] Реализовать DocumentService (базовые CRUD операции)
- [ ] Реализовать DocumentHistoryService
- [ ] Реализовать ApprovalRegistryService

### Этап 4: API Endpoints
- [ ] **POST /api/documents** - Создание документа (статус DRAFT, автогенерация номера)
- [ ] **GET /api/documents/{id}** - Получение документа с историей
- [ ] **GET /api/documents** - Получение списка документов:
  - [ ] Поддержка пагинации и сортировки
  - [ ] Пакетное получение по списку id
  - [ ] Режим с историей/без истории
- [ ] **POST /api/documents/submit** - Отправка на согласование (пакетная, 1-1000 id)
- [ ] **POST /api/documents/approve** - Утверждение (пакетная, 1-1000 id)
- [ ] **GET /api/documents/search** - Поиск с фильтрами (статус, автор, период дат)
- [ ] **POST /api/documents/test-concurrent-approve** - Тест конкурентного утверждения

### Этап 5: Бизнес-логика
- [ ] Реализовать генерацию уникального номера документа
- [ ] Реализовать переход статуса DRAFT -> SUBMITTED:
  - [ ] Проверка текущего статуса
  - [ ] Атомарная операция
  - [ ] Запись в историю
  - [ ] Обработка конфликтов
- [ ] Реализовать переход статуса SUBMITTED -> APPROVED:
  - [ ] Проверка текущего статуса
  - [ ] Атомарная операция
  - [ ] Запись в историю
  - [ ] Создание записи в реестре утверждений
  - [ ] Откат при ошибке записи в реестр (транзакция)
  - [ ] Обработка конфликтов и ошибок
- [ ] Реализовать пакетную обработку с частичными результатами
- [ ] Реализовать конкурентное утверждение с проверкой

### Этап 6: Фоновая обработка (Workers)
- [ ] Создать конфигурацию для batchSize
- [ ] Реализовать SUBMIT-worker:
  - [ ] Периодическая проверка документов со статусом DRAFT
  - [ ] Обработка пачками по batchSize
  - [ ] Вызов пакетного API submit
  - [ ] Логирование прогресса
- [ ] Реализовать APPROVE-worker:
  - [ ] Периодическая проверка документов со статусом SUBMITTED
  - [ ] Обработка пачками по batchSize
  - [ ] Вызов пакетного API approve
  - [ ] Логирование прогресса
- [ ] Настроить Spring Scheduling для фоновых задач

### Этап 7: Утилита массового создания
- [ ] Создать отдельный модуль/утилиту
- [ ] Реализовать чтение параметра N из файла конфигурации
- [ ] Реализовать создание N документов через API
- [ ] Добавить логирование прогресса создания

### Этап 8: DTO и валидация
- [ ] Создать DTO классы:
  - [ ] CreateDocumentRequest
  - [ ] DocumentResponse
  - [ ] DocumentListResponse
  - [ ] BatchSubmitRequest
  - [ ] BatchApproveRequest
  - [ ] BatchOperationResult
  - [ ] SearchRequest
  - [ ] ConcurrentTestRequest
- [ ] Добавить валидацию входных данных (@Valid, @NotNull, и т.д.)
- [ ] Реализовать единый формат ошибок (ErrorResponse)

### Этап 9: Обработка ошибок
- [ ] Создать глобальный ExceptionHandler
- [ ] Реализовать обработку:
  - [ ] DocumentNotFoundException
  - [ ] StatusTransitionException (конфликт)
  - [ ] ValidationException
  - [ ] RegistryException
- [ ] Единый формат ответа с кодом и сообщением

### Этап 10: Логирование
- [ ] Настроить структурированное логирование
- [ ] Логирование создания документов (прогресс)
- [ ] Логирование времени выполнения операций
- [ ] Логирование фоновой обработки (обработано/осталось)

### Этап 11: Тесты
- [ ] Unit тесты для сервисов
- [ ] Интеграционные тесты:
  - [ ] Happy-path: создание и получение одного документа
  - [ ] Пакетный submit с частичными результатами
  - [ ] Пакетный approve с частичными результатами
  - [ ] Откат approve при ошибке записи в реестр
  - [ ] Конкурентное утверждение

### Этап 12: Документация
- [ ] README.md:
  - [ ] Описание проекта
  - [ ] Инструкции по запуску (сервис и утилита)
  - [ ] Описание API endpoints
  - [ ] Как проверить прогресс по логам
  - [ ] Описание фильтров поиска (период дат)
- [ ] EXPLAIN.md:
  - [ ] Пример поискового запроса
  - [ ] EXPLAIN (ANALYZE) результат
  - [ ] Пояснение по индексам

### Этап 13: Опциональные улучшения (описание в README)
- [ ] Описать оптимизации для обработки 5000+ id
- [ ] Описать архитектуру выноса реестра в отдельную систему

## Технические детали

### Структура проекта
```
src/
├── main/
│   ├── java/
│   │   └── com/itq/
│   │       ├── controller/
│   │       ├── service/
│   │       ├── repository/
│   │       ├── entity/
│   │       ├── dto/
│   │       ├── config/
│   │       ├── exception/
│   │       └── util/
│   └── resources/
│       ├── application.yml
│       └── db/changelog/
├── test/
└── utility/
    └── src/main/java/... (модуль утилиты)
```

### Ключевые технологии
- Java 17+
- Spring Boot 3.x
- Spring Data JPA
- PostgreSQL
- Liquibase
- Docker Compose
- Maven/Gradle

### Важные моменты
1. **Транзакционность**: Утверждение документа и запись в реестр должны быть атомарными
2. **Конкурентность**: Обработка конкурентных запросов на утверждение
3. **Производительность**: Пакетная обработка до 1000 документов
4. **Надежность**: Частичные ошибки не должны останавливать обработку
5. **Логирование**: Детальное логирование для отслеживания прогресса

## Порядок реализации (рекомендуемый)
1. Сначала настроить инфраструктуру (БД, миграции)
2. Затем базовые сущности и репозитории
3. Потом API endpoints по одному
4. После этого бизнес-логику и валидацию
5. Фоновые процессы
6. Утилиту
7. Тесты и документацию
